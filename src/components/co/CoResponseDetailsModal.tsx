import { useState } from "react";
import type { ChangeEvent } from "react";
import Button from "../fields/Button";
import Service from "../../api/Service";
import RenderFiles from "../ui/RenderFiles";

const STATUS_OPTIONS = ["PENDING", "APPROVED", "REJECTED"];

const COResponseDetailsModal = ({ response, onClose, onSuccess }: any) => {
  const [replyMessage, setReplyMessage] = useState("");
  const [replyFiles, setReplyFiles] = useState<File[]>([]);
  const [replyStatus, setReplyStatus] = useState("PENDING");
  const userId = sessionStorage.getItem("userId") || "";
  const userRole = sessionStorage.getItem("userRole") || "";
  console.log(response);

  const handleReply = async () => {
    if (!replyMessage.trim()) return;

    const formData = new FormData();
    formData.append("CoId", response.CoId);
    formData.append("description", replyMessage);
    formData.append("status", replyStatus);
    formData.append("userId", userId);
    formData.append("userRole", userRole);

    // ✅ IMPORTANT — reply points to parent response
    formData.append("parentResponseId", response.id);

    replyFiles.forEach((f) => formData.append("files", f));

    await Service.addCOResponse(formData, response.id);

    onSuccess();
    onClose();
  };

  return (
    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 backdrop-blur-sm">
      <div className="bg-[#fafffb] p-8 w-full max-w-lg rounded-3xl shadow-2xl relative space-y-4 border border-green-100/50">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-xl font-black text-black uppercase tracking-tight">
            Response Details
          </h2>
          <button
            onClick={onClose}
            className="px-6 py-1.5 bg-red-50 text-black border-2 border-red-700/80 rounded-lg hover:bg-red-100 transition-all font-bold text-sm uppercase tracking-tight shadow-sm"
          >
            Close
          </button>
        </div>

        <p className="bg-gray-100 p-3 rounded border">{response.description}</p>

        <RenderFiles
          files={response.files}
          table="cOResponse"
          parentId={response.id}
        />

        {/* Reply */}
        <textarea
          value={replyMessage}
          onChange={(e) => setReplyMessage(e.target.value)}
          rows={3}
          className="w-full border rounded p-2"
          placeholder="Reply..."
        />

        <select
          value={replyStatus}
          onChange={(e) => setReplyStatus(e.target.value)}
          className="w-full border rounded p-2"
        >
          {STATUS_OPTIONS.map((s) => (
            <option key={s} value={s}>
              {s}
            </option>
          ))}
        </select>

        <input
          type="file"
          multiple
          onChange={(e: ChangeEvent<HTMLInputElement>) =>
            setReplyFiles(e.target.files ? Array.from(e.target.files) : [])
          }
        />

        <div className="flex justify-end gap-3">
          <Button onClick={onClose} className="px-4 py-2 bg-gray-100 text-black rounded-lg font-bold uppercase tracking-tight hover:bg-gray-200 transition-all border border-gray-200">Cancel</Button>
          <Button
            className="px-6 py-2 bg-black text-white rounded-lg font-bold uppercase tracking-tight hover:bg-black/90 transition-all border border-black shadow-md"
            onClick={handleReply}
          >
            Send Reply
          </Button>
        </div>
      </div>
    </div>
  );
};

export default COResponseDetailsModal;
